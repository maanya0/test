task:
  name: Debug macOS via VNC
  macos_instance:
    image: monterey-base  # or "ventura-base" depending on Cirrus availability

  env:
    NGROK_AUTH_TOKEN: ENCRYPTED[4cd5c046b7b268ace39fe5d20372fcbafaa177ce1fd3d7fb71600e813ea82382b3b014d88e092e76d565a8b933ec5db7]
  setup_script:
    # Install ngrok
    - brew install --cask ngrok

    # Enable screen sharing (VNC)
    - sudo systemsetup -setremotelogin on
    - sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true
    - sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
        -activate -configure -access -on \
        -clientopts -setvnclegacy -vnclegacy yes \
        -clientopts -setvncpw -vncpw "cirrusdebug" \
        -restart -agent -privs -all

  tunnel_script:
    # Start ngrok tunnel for VNC
    - ngrok config add-authtoken $NGROK_AUTH_TOKEN
    - nohup ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &
    - sleep 10
    - grep -o "tcp://[0-9a-zA-Z.:]*" ngrok.log || true

  sleep_script:
    - echo "VNC password: cirrusdebug"
    - echo "Use the ngrok tcp:// address above in your VNC client."
    - sleep 7200
